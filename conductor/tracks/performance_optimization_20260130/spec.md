# Specification: Critical Performance and Memory Optimization\n\n## Overview\nThis track addresses a severe performance regression and memory leak where the application exhibits extreme lag from startup and consumes over 4GB of browser memory within minutes. This indicates a systemic failure in the event processing pipeline, likely characterized by an unbounded accumulation of data in memory or an infinite loop of state updates.\n\n## Problem Analysis\n- **Memory Leak:** Steady accumulation of memory while idle (up to 4GB+) strongly suggests that events, relay connections, or state objects are being duplicated or not garbage-collected.\n- **UI Lag:** Constant "jank" and slow loading from startup point to a blocked main thread, likely caused by heavy synchronous processing of incoming Nostr events or inefficient React re-renders.\n- **Initial Diagnosis:** Suspect areas include 'nostrService' subscription management, 'useFeed' throttling/caching, and 'VirtualFeed' row management.\n\n## Functional Requirements\n- **Unbounded Growth Prevention:** Implement strict caps on the number of events stored in memory and ensure old events are evicted when limits are reached.\n- **Asynchronous Event Processing:** Ensure all event validation and parsing happens off the main thread (verify Web Worker usage).\n- **Efficient State Updates:** Refactor feed state management to use batched or throttled updates to prevent React from being overwhelmed by a flood of incoming events.\n- **Memory Management:** Implement a robust cleanup mechanism for closed relay subscriptions and stale cache entries.\n\n## Non-Functional Requirements\n- **Target Memory Usage:** Stable memory consumption under 500MB for a typical session.\n- **Responsiveness:** Maintain a consistent 60fps UI performance during event ingestion.\n- **Loading Speed:** Historical events should be visible within 2 seconds of feed initialization.\n\n## Acceptance Criteria\n- Browser tab memory usage remains stable and does not exceed 500MB after 10 minutes of idle time.\n- UI interaction (scrolling, clicking) is smooth and responsive from the moment the app loads.\n- Relay subscriptions are correctly closed and cleaned up when a feed or community layer is popped.\n\n## Out of Scope\n- Redesigning the feed UI layout.\n- Implementing a persistent backend database (all fixes must be client-side).
